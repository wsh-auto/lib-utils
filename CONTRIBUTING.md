# Development Guidelines for lib-utils

## Build Architecture

lib-utils has optional dependencies (`@mdr/lib-1password`, `@mdr/lib-log`) that don't exist in CI environments. This creates a TypeScript compilation challenge: the source files import these modules, but TypeScript can't resolve them.

**Solution:** Two-layer type system.

```
lib-utils/
├── src/
│   ├── env.ts          # await import('@mdr/lib-1password')
│   └── logger.ts       # await import('@mdr/lib-log')
├── stubs/              # Type stubs for optional deps (build-time)
│   ├── lib-1password.d.ts
│   └── lib-log.d.ts
└── dist/               # Generated .d.ts (consumer-facing)
    ├── env.d.ts
    └── logger.d.ts
```

### How It Works

1. **stubs/** - `declare module` statements that tell TypeScript "trust me, these modules export these types". Referenced via `paths` in tsconfig.build.json only.

2. **dist/** - Clean declaration files generated by `tsc`. These don't contain the problematic imports (TypeScript inlines the types).

3. **Consumers** import from `dist/*.d.ts` (via package.json `exports.types`), which `skipLibCheck: true` ignores.

### tsconfig Structure

**Critical:** Bun uses tsconfig.json `paths` for runtime module resolution, not just TypeScript compilation. Stubs must only be in build config.

| File | Purpose | Has paths? |
|------|---------|:----------:|
| `tsconfig.json` | Base config, used by Bun at runtime | ❌ |
| `tsconfig.build.json` | Generates `dist/*.d.ts` | ✅ |
| `tsconfig.check.json` | Typecheck validation | ✅ (extends build) |

| Command | Config | Emits |
|---------|--------|-------|
| `bun run build` | tsconfig.build.json | `dist/*.d.ts` |
| `bun run typecheck` | tsconfig.check.json | Nothing (validation only) |

### Important

- **Do not delete `stubs/`** - required for build to succeed
- **Do not delete `dist/`** - consumers need these declaration files
- **Do not add `paths` to tsconfig.json** - Bun resolves to stubs at runtime, breaking imports
- **Commit `dist/`** - consumers install via `github:`, no build step on install
- After modifying source, run `bun run build` to regenerate `dist/`
